# Codeck — Managed Mode
#
# Daemon on host (Node.js) + runtime in isolated Docker container.
# Daemon handles auth, webapp, port exposure. Runtime is never exposed.
# Works on Linux, macOS, and Windows.
#
# Usage (via CLI — recommended):
#   codeck init     # choose "Managed"
#   codeck start    # starts container + daemon
#
# Manual usage:
#   CODECK_DATA_DIR=./.codeck-data docker compose -f docker/compose.managed.yml up -d --build
#   CODECK_DIR=./.codeck-data CODECK_DAEMON_PORT=8080 CODECK_RUNTIME_URL=http://127.0.0.1:7777 \
#     node apps/daemon/dist/index.js
#
# Architecture:
#   Host daemon (:8080) → Runtime container (:7777 HTTP, :7778 WS)
#   Only localhost ports — not exposed to the internet.

services:
  runtime:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: codeck-runtime
    restart: unless-stopped
    init: true
    stdin_open: true
    tty: true
    ports:
      - "127.0.0.1:7777:7777"
      - "127.0.0.1:7778:7778"
    environment:
      - CODECK_PORT=7777
      - CODECK_WS_PORT=7778
      - CODECK_NETWORK_MODE=bridge
      - CODECK_DAEMON_URL=http://host.docker.internal:${CODECK_DAEMON_PORT:-8080}
      - CODECK_DIR=/data/.codeck
      - CODECK_INTERNAL_SECRET=${CODECK_INTERNAL_SECRET:-}
      - CODECK_DAEMON_PORT=${CODECK_DAEMON_PORT:-8080}
      - WORKSPACE=/workspace
      - CODECK_HOST_WORKSPACE=${CODECK_WORKSPACE:-}
      - CODECK_UID=${CODECK_UID:-}
      - CODECK_GID=${CODECK_GID:-}
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE
      - KILL
      # DAC_OVERRIDE required: workspace/data are bind-mounted from the host (owned by
      # the codeck user, uid≠0). Without DAC_OVERRIDE, root inside the container cannot
      # write to files it doesn't own even though it has uid=0.
      - DAC_OVERRIDE
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
          pids: 512
        reservations:
          memory: 512M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    stop_grace_period: 30s
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7777/api/auth/status"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /run:size=100M,mode=0755
      - /run/dbus:size=10M,mode=0755
      - /var/run:size=10M,mode=0755
    volumes:
      - ${CODECK_WORKSPACE:-workspace}:/workspace
      - ${CODECK_CLAUDE_CONFIG:-claude-config}:/root/.claude
      - ${CODECK_SSH_DATA:-ssh-data}:/root/.ssh:ro
      - ${CODECK_GH_CONFIG:-gh-config}:/root/.config/gh
      # Shared data dir — bind-mounted from host so daemon and runtime share auth.json
      - ${CODECK_DATA_DIR:-./.codeck-data}:/data/.codeck
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: ["/usr/local/bin/init-keyring.sh", "env", "NODE_ENV=production", "node", "apps/runtime/dist/index.js"]
    command: ["--web"]

volumes:
  workspace:
  claude-config:
  ssh-data:
  gh-config:
