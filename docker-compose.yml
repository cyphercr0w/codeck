# Codeck
#
# Usage:
#   docker compose up                            # Webapp mode (localhost)
#   docker compose run --rm sandbox --help       # Show help
#
# LAN access (codeck.local from any device):
#   docker compose -f docker-compose.yml -f docker-compose.lan.yml up
#
# Dev (build from source):
#   docker compose -f docker-compose.yml -f docker-compose.dev.yml up --build

services:
  sandbox:
    build: .
    restart: unless-stopped
    init: true          # tini as PID 1 — reaps zombie processes from dev servers
    stdin_open: true
    tty: true
    ports:
      - "${CODECK_PORT:-80}:${CODECK_PORT:-80}"
    cap_drop:
      - ALL
    cap_add:
      - CHOWN           # File ownership changes (npm, git)
      - SETUID          # User switching (dbus, keyring)
      - SETGID          # Group switching (dbus, keyring)
      - NET_BIND_SERVICE # Bind to ports < 1024
      - KILL            # Signal processes (dev server cleanup)
      - DAC_OVERRIDE    # File permission overrides (gnome-keyring, dbus, ssh)
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
          pids: 512
        reservations:
          memory: 512M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    stop_grace_period: 30s
    # read_only: true — disabled: Claude CLI auto-update requires writable /usr/local/
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /run:size=100M,mode=0755
      - /run/dbus:size=10M,mode=0755
      - /var/run:size=10M,mode=0755
    volumes:
      - workspace:/workspace
      - codeck-data:/workspace/.codeck
      - claude-config:/root/.claude
      - ssh-data:/root/.ssh
      # Docker socket is NOT mounted by default for security.
      # To enable Docker access (experimental), use:
      #   docker compose -f docker-compose.yml -f docker-compose.experimental.yml up
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - CODECK_NETWORK_MODE=bridge
      - CODECK_PORT=${CODECK_PORT:-80}
      - CODECK_MAPPED_PORTS=${CODECK_PORT:-80}

      # GitHub token legacy (optional)
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}

      # Anthropic API Key (alternative to OAuth login)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

    command: ["--web"]

volumes:
  workspace:
  codeck-data:
  claude-config:
  ssh-data:
