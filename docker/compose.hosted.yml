# Codeck — Hosted Mode (VPS)
#
# Runtime-only container for VPS deployment. The daemon runs natively
# on the host as a systemd service and proxies to this container.
#
# Usage (managed by systemd — see scripts/codeck.service):
#   docker compose -f docker/compose.hosted.yml up -d
#
# Architecture:
#   Host daemon (:80) → Runtime container (:7777 HTTP, :7778 WS)
#   Only localhost ports — not exposed to the internet.

services:
  runtime:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: codeck-runtime
    restart: unless-stopped
    init: true
    stdin_open: true
    tty: true
    ports:
      - "127.0.0.1:7777:7777"
      - "127.0.0.1:7778:7778"
    environment:
      - CODECK_PORT=7777
      - CODECK_WS_PORT=7778
      - CODECK_NETWORK_MODE=bridge
      - WORKSPACE=/workspace
      - CODECK_UID=${CODECK_UID:-}
      - CODECK_GID=${CODECK_GID:-}
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE
      - KILL
      - DAC_OVERRIDE
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
          pids: 512
        reservations:
          memory: 512M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    stop_grace_period: 30s
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:7777/api/auth/status"]
      interval: 30s
      timeout: 5s
      start_period: 10s
      retries: 3
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /run:size=100M,mode=0755
      - /run/dbus:size=10M,mode=0755
      - /var/run:size=10M,mode=0755
    volumes:
      - /home/codeck/workspace:/workspace
      - /home/codeck/.claude:/root/.claude
      - /home/codeck/.ssh:/root/.ssh
      - /home/codeck/.config/gh:/root/.config/gh
      # No Docker socket — runtime is isolated. Port exposure is managed by the host daemon.
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: ["/usr/local/bin/init-keyring.sh", "env", "NODE_ENV=production", "node", "apps/runtime/dist/index.js"]
    command: ["--web"]
