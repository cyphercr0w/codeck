# Codeck
#
# Usage:
#   docker compose -f docker/compose.yml up
#   docker compose -f docker/compose.yml run --rm sandbox --help
#
# LAN access (codeck.local from any device):
#   docker compose -f docker/compose.yml -f docker/compose.lan.yml up
#
# Dev (build from source):
#   docker compose -f docker/compose.yml -f docker/compose.dev.yml up --build

services:
  sandbox:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    restart: unless-stopped
    init: true          # tini as PID 1 — reaps zombie processes from dev servers
    stdin_open: true
    tty: true
    ports:
      - "${CODECK_PORT:-80}:${CODECK_PORT:-80}"
    cap_drop:
      - ALL
    cap_add:
      - CHOWN           # File ownership changes (npm, git)
      - SETUID          # User switching (dbus, keyring)
      - SETGID          # Group switching (dbus, keyring)
      - NET_BIND_SERVICE # Bind to ports < 1024
      - KILL            # Signal processes (dev server cleanup)
      - DAC_OVERRIDE    # File permission overrides (gnome-keyring, dbus, ssh)
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
          pids: 512
        reservations:
          memory: 512M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    stop_grace_period: 30s
    # read_only: true — disabled: Claude CLI auto-update requires writable /usr/local/
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /run:size=100M,mode=0755
      - /run/dbus:size=10M,mode=0755
      - /var/run:size=10M,mode=0755
    volumes:
      - workspace:/workspace
      - claude-config:/root/.claude
      - ssh-data:/root/.ssh
      - gh-config:/root/.config/gh
      # WARNING: Docker socket grants host-level access. Required by port-manager
      # for dynamic port mapping. For security-sensitive deployments, consider using
      # a Docker socket proxy (e.g., tecnativa/docker-socket-proxy) instead.
      # See docs/CONFIGURATION.md for details.
      - /var/run/docker.sock:/var/run/docker.sock
    extra_hosts:
      - "host.docker.internal:host-gateway"
    environment:
      - CODECK_NETWORK_MODE=bridge
      - CODECK_PORT=${CODECK_PORT:-80}
      - CODECK_MAPPED_PORTS=${CODECK_PORT:-80}

      # GitHub token legacy (optional)
      - GITHUB_TOKEN=${GITHUB_TOKEN:-}

      # Anthropic API Key (alternative to OAuth login)
      - ANTHROPIC_API_KEY=${ANTHROPIC_API_KEY:-}

    command: ["--web"]

volumes:
  workspace:
  claude-config:
  ssh-data:
  gh-config:
