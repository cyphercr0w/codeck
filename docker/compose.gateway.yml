# Codeck — Gateway Mode
#
# Two-container deployment: daemon (public) + runtime (private).
# Only the daemon is exposed to the host; the runtime is internal.
#
# Usage:
#   docker compose -f docker/compose.gateway.yml up --build
#
# With nginx in front:
#   nginx → daemon:8080 → runtime (codeck_net)

services:
  daemon:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    restart: unless-stopped
    init: true
    ports:
      - "${CODECK_DAEMON_PORT:-8080}:8080"
    networks:
      - codeck_net
    environment:
      - CODECK_DAEMON_PORT=8080
      - CODECK_RUNTIME_URL=http://codeck-runtime:7777
      - CODECK_RUNTIME_WS_URL=http://codeck-runtime:7778
      - CODECK_DIR=/workspace/.codeck
    volumes:
      - workspace:/workspace
    cap_drop:
      - ALL
    cap_add:
      - NET_BIND_SERVICE
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 256M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "5m"
        max-file: "3"
    entrypoint: ["env", "NODE_ENV=production", "node", "apps/daemon/dist/index.js"]
    command: []

  runtime:
    build:
      context: ..
      dockerfile: docker/Dockerfile
    container_name: codeck-runtime
    restart: unless-stopped
    init: true
    stdin_open: true
    tty: true
    networks:
      - codeck_net
    # No ports exposed to host — only reachable via codeck_net
    environment:
      - CODECK_PORT=7777
      - CODECK_WS_PORT=7778
      - CODECK_NETWORK_MODE=bridge
      - WORKSPACE=/workspace
    cap_drop:
      - ALL
    cap_add:
      - CHOWN
      - SETUID
      - SETGID
      - NET_BIND_SERVICE
      - KILL
      - DAC_OVERRIDE
    security_opt:
      - no-new-privileges:true
    deploy:
      resources:
        limits:
          memory: 4G
          cpus: '2.0'
          pids: 512
        reservations:
          memory: 512M
          cpus: '0.5'
    logging:
      driver: "json-file"
      options:
        max-size: "10m"
        max-file: "3"
        compress: "true"
    stop_grace_period: 30s
    tmpfs:
      - /tmp:size=512M,mode=1777
      - /run:size=100M,mode=0755
      - /run/dbus:size=10M,mode=0755
      - /var/run:size=10M,mode=0755
    volumes:
      - workspace:/workspace
      - claude-config:/root/.claude
      - ssh-data:/root/.ssh
      - gh-config:/root/.config/gh
      - /var/run/docker.sock:/var/run/docker.sock
    extra_hosts:
      - "host.docker.internal:host-gateway"
    entrypoint: ["/usr/local/bin/init-keyring.sh", "env", "NODE_ENV=production", "node", "apps/runtime/dist/index.js"]
    command: ["--web"]

networks:
  codeck_net:
    driver: bridge

volumes:
  workspace:
  claude-config:
  ssh-data:
  gh-config:
