# Codeck - Base Image
# Contains system tools, language runtimes, and agent CLIs
# Build once: docker build -t codeck-base -f docker/Dockerfile.base .

# Pinned to digest for reproducible builds. Update periodically for security patches.
# Update cadence: Check monthly via `docker pull node:22-slim && docker inspect node:22-slim | jq -r '.[0].RepoDigests[0]'`
# Last verified: 2026-02-14 (digest sha256:5373f190...)
# To update: curl -s "https://hub.docker.com/v2/repositories/library/node/tags/22-slim" | jq -r '.digest'
# Security-critical CVEs may warrant immediate update (monitor Debian Security Advisories)
FROM node:22-slim@sha256:5373f1906319b3a1f291da5d102f4ce5c77ccbe29eb637f072b6c7b70443fc36

# ─── System essentials ───
RUN apt-get update && apt-get install -y --no-install-recommends \
    build-essential \
    python3 \
    python3-pip \
    python3-venv \
    curl \
    wget \
    git \
    jq \
    unzip \
    nano \
    ca-certificates \
    openssh-client \
    iproute2 \
    dnsutils \
    expect \
    dbus \
    dbus-x11 \
    gnome-keyring \
    libsecret-1-0 \
    libsecret-1-dev \
    libsecret-tools \
    && rm -rf /var/lib/apt/lists/*

# ─── GitHub CLI ───
RUN curl -fsSL https://cli.github.com/packages/githubcli-archive-keyring.gpg \
    | dd of=/usr/share/keyrings/githubcli-archive-keyring.gpg \
    && echo "deb [signed-by=/usr/share/keyrings/githubcli-archive-keyring.gpg] https://cli.github.com/packages stable main" \
    | tee /etc/apt/sources.list.d/github-cli.list \
    && apt-get update && apt-get install -y gh \
    && rm -rf /var/lib/apt/lists/*

# ─── Docker CLI (uses host's Docker daemon via socket mount) ───
RUN install -m 0755 -d /etc/apt/keyrings \
    && curl -fsSL https://download.docker.com/linux/debian/gpg -o /etc/apt/keyrings/docker.asc \
    && echo "deb [signed-by=/etc/apt/keyrings/docker.asc] https://download.docker.com/linux/debian bookworm stable" \
    | tee /etc/apt/sources.list.d/docker.list \
    && apt-get update && apt-get install -y --no-install-recommends docker-ce-cli docker-compose-plugin \
    && rm -rf /var/lib/apt/lists/*

# ─── Agent CLIs ───
# Currently only Claude Code. Add other agent CLIs here as needed.
# Pinned version for supply chain safety. Update explicitly after testing.
# Server can auto-update at runtime via POST /api/system/update-agent.
RUN npm install -g pnpm @anthropic-ai/claude-code@2.1.39

# ─── Prebuilt native modules ───
RUN mkdir -p /prebuilt && cd /prebuilt && npm init -y && npm install node-pty better-sqlite3

# ─── Directory structure ───
RUN mkdir -p /app /workspace /workspace/.codeck /root/.claude /root/.ssh /run/dbus

# ─── Keyring initialization ───
RUN echo '#!/bin/bash\n\
# Start D-Bus if not running\n\
if [ ! -e /run/dbus/pid ]; then\n\
  dbus-daemon --system --fork 2>/dev/null || true\n\
fi\n\
\n\
# Initialize D-Bus session\n\
export $(dbus-launch)\n\
\n\
# Initialize keyring with empty password and export control vars\n\
eval $(echo "" | gnome-keyring-daemon --unlock --components=secrets 2>/dev/null)\n\
export GNOME_KEYRING_CONTROL\n\
export SSH_AUTH_SOCK\n\
\n\
# Execute the original command\n\
exec "$@"\n\
' > /usr/local/bin/init-keyring.sh && chmod +x /usr/local/bin/init-keyring.sh

WORKDIR /app
